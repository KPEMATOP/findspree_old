/**
 * Created by dev on 12.03.15.
 */
function EventInPanel(panelId, html) {
    var asHtml = html ? true : false;
    var $panel = $(panelId);
    var data = {};
    var $empty = $panel.find('.panel-empty').hide();
    var $head = $(panelId).find('.panel-heading');
    var $body = $(panelId).find('.panel-body');
    var $counter = $(panelId).find('.counter');
    var tpl = _.template($('#tpl-event-item').html());
    var $footer = $(panelId).find('.panel-footer');
    var self = this;
    var initilized=false;
    this.init = function () {
        var url = $panel.data('remote-self')
        this.update(url);
    };
    this.render = function () {
        var html;
        if(!asHtml) {
            html = '';
            _.each(data.items, function (item) {
                item.description = Helper.String.truncate(item.description, 25);
                html += tpl(item);
            });
        }else{
            html = data.content;
        }

        if(initilized){
            var offset = $body[0].scrollHeight;
            $body.append(html);
            $body.animate({scrollTop: offset}, '500', 'swing');
        }else{
            $body.append(html);
        }
        var meta = data._meta;
        if(meta.totalCount==0){
            $empty.show();
            $body.hide();
            $footer.hide();
            return;
        }else{
            $empty.hide();
            $body.show();
            $footer.show();
        }
        if (meta.currentPage == meta.pageCount) {
            $footer.slideUp(500);
        } else {
            $footer.slideDown(500);
        }
        var number = (meta.perPage * meta.currentPage);
        if (number > meta.totalCount)
            number = meta.totalCount;
        $counter.text('(' + (number) + '/' + meta.totalCount + ')');
        if(!initilized){
            initilized=true;
        }
    };
    this.next = function () {
        if (!data._links)return false;
        this.update(data._links.next.href)
    };


    this.update = function (url) {
        $.get(url, function (d) {
            data = d;
            self.render()
        });
    };
    $footer.click(this.next.bind(this));
    this.init();
};

(function () {
    var eventSubscribe = new EventInPanel('#event-list-subscribe');
    var eventCreate = new EventInPanel('#event-list-create');
    var eventCreate = new EventInPanel('#wall-list', true);
    //$(document).on('fs.event.subscribed','.event-control-subscribe',function(){
    //    eventSubscribe.current();
    //    eventCreate.current();
    //});
    $('#user-subscribe').on('click', function () {
        var e = $(this);
        var url = $(this).data('remote');
        var oldClass = e.attr('class');
        $.getJSON(url, function (data) {
            if (e.hasClass('btn-success')) {
                e.removeClass('btn-success');
                e.addClass('btn-info');
                e.find('span').text('ПОДПИСАТЬСЯ')
            } else {
                e.removeClass('btn-info');
                e.addClass('btn-success');
                e.find('span').text('ВЫ ПОДПИСАНЫ')
            }
            if (data.error) {
                e.attr('class', oldClass);
            }
        });
    });
}());