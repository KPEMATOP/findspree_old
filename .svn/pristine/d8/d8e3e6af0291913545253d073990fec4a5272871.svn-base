/**
 * Created by dev on 12.03.15.
 */

(function () {
    function List(params) {

        params = _.extend({
            $el: null,
            tpl: null,
            itemClass: ''
        }, params);
        this.startUrl = params.$el.data('remote');
        this.url = this.startUrl;
        this.tpl = params.tpl;
        this.$el = params.$el;
        this.$footer = this.$el.find('.panel-footer').hide();
        this.$empty = this.$el.find('.panel-empty').show();
        this.$body = this.$el.find('.panel-body').hide();
        this.itemClass = params.itemClass;
        this.$footer.click(function () {
            this.load();
        }.bind(this));
        this.loading = false;
        $(window).scroll(function () {
            if (!this.loading && this.$el.is(':visible') && $(window).scrollTop() + $(window).height() > $(document).height() * 0.8) {
                this.load()
            }
        }.bind(this));
    }
    List.prototype.showLoading= function(){
        this.$empty.show();
        this.$empty.find('.md-sync').show();
        this.$empty.find('.md-event-note').hide();
    };
    List.prototype.showEmpty= function(){
        this.$empty.show();
        this.$empty.find('.md-sync').hide();
        this.$empty.find('.md-event-note').show();
        this.$footer.hide();
    };

    List.prototype.load = function (reset) {
        if (!this.url)return;
        if (reset) {
            this.url = this.startUrl;
            this.$body.html('');
        }
        this.loading = true;
        this.showLoading();
        $.get(this.url, function (data) {
            this.$empty.hide();
            this.url = null;
            if (data._links.next) {
                this.url = data._links.next.href;
            }
            var meta = data._meta;
            if (meta.currentPage == meta.pageCount) {
                this.$footer.slideUp(500);
            } else {
                this.$footer.slideDown(500);
            }
            this.loading = false;
            this.$body.show();
            this.$empty.hide();
            if (data && data.items)
                this.render(data)
        }.bind(this));
    };
    List.prototype.render = function (data) {
        var html = '';
        if (!data)return false;
        if(data._meta.pageCount==0){
            this.showEmpty();
            return;
        }
        _.each(data.items, function (e) {
            console.log(e);
            var dt = _.extend({
                itemStyle: this.itemClass
            }, e);
            if (_.isFunction(this.tpl)) {
                html += this.tpl(e)
            } else {
                html += this.tpl(dt);
            }
        }.bind(this));
        this.$body.append(html)
    };

    var listEventSubscribe, action, listEventCreate;
    var html2 = $('#tpl-event-wide').html(), listWall;
    listEventSubscribe = new List({
        $el: $('#act-event-subscribe'),
        tpl: _.template(html2)
    });
    listEventCreate = new List({
        $el: $('#act-event-create'),
        tpl: _.template(html2)
    });
    listWall = new List({
        $el: $('#act-wall'),
        tpl: function (e) {
            if (wallViews[e.type])
                return wallViews[e.type](e);
            return '';
        }
    });
    var wallViews = {
        1: _.template($("#tpl-wall-subscribe-event").html()),
        2: _.template($("#tpl-wall-subscribe-user").html()),
        3: _.template($("#tpl-wall-new-event").html())
    };
    var lastAction = '';
    var loading = false;
    action = {
        wall: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-wall').addClass('active');
            var $act = $('#act-wall');
            $act.show();
            listWall.load(true);
        },
        eventSubscribe: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-event-subscribe').addClass('active');
            var $act = $('#act-event-subscribe');
            $act.show();
            listEventSubscribe.load(true);

        },
        eventCreated: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-event-create').addClass('active');
            var $act = $('#act-event-create');
            $act.show();
            listEventCreate.load(true);
        },
        userSubscribe: function () {

        },
        userSubscribers: function () {

        }
    };
    action.wall();
    $('.menu-item').click(function () {
        var actionName = $(this).data('action');
        if (action[actionName]) {
            action[actionName]();
            lastAction = actionName;
        }
        return false;
    });
}());

$('#user-subscribe').on('click', function () {
    var e = $(this);
    var url = $(this).data('remote');
    var oldClass = e.attr('class');
    $.getJSON(url, function (data) {
        if (e.hasClass('btn-success')) {
            e.removeClass('btn-success');
            e.addClass('btn-info');
            e.find('span').text('ПОДПИСАТЬСЯ')
        } else {
            e.removeClass('btn-info');
            e.addClass('btn-success');
            e.find('span').text('ВЫ ПОДПИСАНЫ')
        }
        if (data.error) {
            e.attr('class', oldClass);
        }
    });
});