/**
 * Created by dev on 12.03.15.
 */

(function () {
    function List(params) {

        params = _.extend({
            $el: null,
            tpl: null,
            itemClass: ''
        }, params);
        this.url = params.$el.data('remote');
        this.tpl = params.tpl;
        this.$el = params.$el;
        this.$footer = this.$el.find('.panel-footer').hide();
        this.$empty = this.$el.find('.panel-empty').show();
        this.$body = this.$el.find('.panel-body').hide();
        this.itemClass = params.itemClass;
        this.$footer.click(function () {
            this.load();
        }.bind(this));
        this.loading = false;
        $(window).scroll(function () {
            if (!this.loading && this.$el.is(':visible') && $(window).scrollTop() + $(window).height() > $(document).height() * 0.8) {
                this.load()
            }
        }.bind(this));
    }

    List.prototype.load = function () {
        if (!this.url)return;
        this.loading = true;
        $.get(this.url, function (data) {
            this.url = null;
            if (data._links.next) {
                this.url = data._links.next.href;
            }
            var meta = data._meta;
            if (meta.currentPage == meta.pageCount) {
                this.$footer.slideUp(500);
            } else {
                this.$footer.slideDown(500);
            }
            this.liveLoad = true;
            this.loading = false;
            this.$body.show();
            this.$empty.hide();
            if (data && data.items)
                this.render(data)
        }.bind(this));
    };
    List.prototype.render = function (data) {
        var html = '';
        if (!data)return false;
        _.each(data.items, function (e) {
            var dt = _.extend({
                itemStyle: this.itemClass
            }, e);
            html += this.tpl(dt);
        }.bind(this));
        this.$body.append(html)
    };

    var eventSubscribe, action, eventCreate;
    var html2 = $('#tpl-event-wide').html();
    eventSubscribe = new List({
        $el: $('#act-event-subscribe'),
        tpl: _.template(html2)
    });
    eventCreate = new List({
        $el: $('#act-event-create'),
        tpl: _.template(html2)
    });
    var wallViews = {
        1: _.template($("#tpl-wall-subscribe-event").html()),
        //3: _.template($("#tpl-subscribe-user").html()),
        3: _.template($("#tpl-wall-new-event").html())
    };
    action = {
        wall: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-wall').addClass('active');
            var $act = $('#act-wall');
            $act.show();
            var url = $act.data('remote');
            var load = function () {
                $.get(url, function (data) {
                    url = '';
                    var html = '';
                    if (!data._links.next)return false;
                    url = data._links.next.href;
                    _.each(data.items, function (e) {
                        console.log(e);
                        if(wallViews[e.type])
                            html+=wallViews[e.type](e);
                    });
                    $act.find('.panel-body').append(html);
                })
            };
            if ($act.find('.panel-body').children().length == 0) load();

        },
        eventSubscribe: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-event-subscribe').addClass('active');
            var $act = $('#act-event-subscribe');
            $act.show();
            if ($act.find('.panel-body').children().length == 0)
                eventSubscribe.load();
        },
        eventCreated: function () {
            $('.act').hide();
            $('.menu-item').removeClass('active');
            $('#menu-event-create').addClass('active');
            var $act = $('#act-event-create');
            $act.show();
            if ($act.find('.panel-body').children().length == 0)
                eventCreate.load();
        },
        userSubscribe: function () {

        },
        userSubscribers: function () {

        }
    };
    action.eventSubscribe();
    $('.menu-item').click(function () {
        var actionName = $(this).data('action');
        if (action[actionName]) {
            action[actionName]();
        }
        return false;
    });
}());

$('#user-subscribe').on('click', function () {
    var e = $(this);
    var url = $(this).data('remote');
    var oldClass = e.attr('class');
    $.getJSON(url, function (data) {
        if (e.hasClass('btn-success')) {
            e.removeClass('btn-success');
            e.addClass('btn-info');
            e.find('span').text('ПОДПИСАТЬСЯ')
        } else {
            e.removeClass('btn-info');
            e.addClass('btn-success');
            e.find('span').text('ВЫ ПОДПИСАНЫ')
        }
        if (data.error) {
            e.attr('class', oldClass);
        }
    });
});