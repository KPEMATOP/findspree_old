/**
 * Created by albert on 22.02.15.
 */
(function () {
    var el, map, geolocation;
    el = {
        $geoTitle: $('#eventform-geotitle'),
        $geoCoordinates: $('#eventform-geocoordinates'),
        $geoDescription: $('#eventform-geodescription')
    };
    ymaps.ready(function () {
        geolocation = ymaps.geolocation;
        var params = {
            center: [59.22, 39.89],
            zoom: 12,
            controls: []
        };
        if (el.$geoCoordinates.length > 0) {
            params.center = el.$geoCoordinates.val().split(',')
            getAddress(params.center)
        }
        map = new ymaps.Map('map', params);
        var searchResult = new ymaps.GeoObjectCollection(null, {
            hintContentLayout: ymaps.templateLayoutFactory.createClass('$[properties.name]')
        });
        el.$geoTitle.on('change', function () {
            var value = $(this).val();
            if (value.length <= 5)return false;
            // Поиск координат центра Нижнего Новгорода.
            ymaps.geocode(value, {
                results: 1 // Если нужен только один результат, экономим трафик пользователей
            }).then(function (res) {
                // Выбираем первый результат геокодирования.
                var node = res.geoObjects.get(0),
                    bounds = node.properties.get('boundedBy');
                searchResult.removeAll()
                searchResult.add(node);
                map.setBounds(bounds, {
                    checkZoomRange: true // проверяем наличие тайлов на данном масштабе.
                });
                el.$geoCoordinates.val(node.geometry.getCoordinates().join());
                el.$geoTitle.val(node.properties.get('name'));
                el.$geoDescription.val(node.properties.get('text'))
            });
        });


        geolocation.get({
            provider: 'yandex',
            mapStateAutoApply: true
        }).then(function (result) {
            map.setCenter(result.geoObjects.get(0).geometry.getCoordinates());
        });

        map.events.add('click', function (e) {
            var coords = e.get('coords');
            getAddress(coords);
        });
        map.geoObjects.add(searchResult);
        function getAddress(coords) {
            //myPlacemark.properties.set('iconContent', 'поиск...');
            ymaps.geocode(coords).then(function (res) {
                searchResult.removeAll();
                var node = res.geoObjects.get(0);
                node.options.set('draggable', true);
                node.events.add('dragend', function (e) {
                    getAddress(e.get('target').geometry.getCoordinates());
                });
                searchResult.add(node);
                el.$geoCoordinates.val(node.geometry.getCoordinates().join());
                el.$geoTitle.val(node.properties.get('name'));
                el.$geoDescription.val(node.properties.get('text'))
            });
        }
    });
    function fillCoordInput(node) {

    }

    var datetimePickerOption = {
        format: 'dd.mm.yyyy hh:ii',
        minView: 0,
        language: 'ru',
        autoclose: true,
        todayBtn: true,
        pickerPosition: "bottom-left",
        startDate: new Date(),
        minuteStep: 10
    };
    $('#eventform-begin').datetimepicker(datetimePickerOption).on('keydown', function () {
        return false;
    });
    $('#eventform-img').change(function () {
        var input = $(this)[0];
        if (input.files && input.files[0]) {
            if (input.files[0].type.match('image.*')) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var $avatarPreview = $('#avatar-preview');
                    //$avatarPreview.parent().show().end().attr('src', e.target.result)
                    $avatarPreview.show().css({
                        'background-image': 'url(' + e.target.result + ')'
                    });
                    //masonry.layout()
                };
                reader.readAsDataURL(input.files[0]);
            } else console.log('is not image mime type');
        } else console.log('not isset files data or files API not supordet');
    });

    //$('#eventform-tag').tagsinput({
    //    maxTags: 5,
    //    maxChars: 30,
    //    confirmKeys: [13, 44, 32,46,33,34,35,36,37,38,39,40,41,42,43,45,47,58,59,60,61,62,63,64,91,92,93,94,96,126,186,187,188,189,190,191,192,219,220,221,222],
    //    trimValue: true
    //});


})();