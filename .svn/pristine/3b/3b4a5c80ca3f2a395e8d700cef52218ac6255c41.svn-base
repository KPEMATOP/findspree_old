/**
 * Created by albert on 09.03.15.
 */
(function () {
    var el;
    el = {
        $map: $('#map'),
        $subscribe: $('#subscribe'),
        $mainContent: $('#main-content')
    };
    var refreshContent=function(){
        $.get('',function(data){
            el.$mainContent.html(data)
        })
    };
    ymaps.ready(function () {
        var center = el.$map.data('coordinates');
        var description = el.$map.data('description');
        var title = el.$map.data('title');
        var params = {
            center: center,
            zoom: 12,
            controls: []
        };
        var map = new ymaps.Map('map', params);
        map.geoObjects.add(new ymaps.Placemark(center, {
            openBalloonOnClick: false
        }, {
            preset: 'islands#dotIcon',
            iconColor: '#3b5998'
        }))
    });
    el.$subscribe.on('click',function(){
        var oldCLass = $(this).attr('class');
        var btn = $(this).children();
        if(!btn.hasClass('btn-success')){
            btn.removeClass('btn-info').addClass('btn-success').text('Вы подписаны')
        }else{
            btn.removeClass('btn-success').addClass('btn-info').text('Подписаться')
        }
        $.get(el.$subscribe.data('remote'),function(data){
            if(data.error){
                btn.attr('class',oldCLass);
            }
            refreshContent();
        })
    });

    load_subscribers();
    load_comments();
})();

function load_subscribers(){
    var page = 1;
    var $tpl = $('#subscriber-event-item');
    var $list = $('#subscriber-container');
    var template = _.template($tpl.text());
    var $buttonNextPage = $('#subscriber-next-page');
    var loadSubscribersPage = function (page) {
        var url = $tpl.data('remote') + '&page=' + page;
        $.get(url, function (data) {
            //console.log(data);
            if (data.pageCount == page) {
                $buttonNextPage.hide()
            }
            $.each(data.items, function (k, v) {
                $list.append(template(v))
            })
        });
    }
    loadSubscribersPage(page);
    $buttonNextPage.click(function () {
        loadSubscribersPage(++page);
        return false;
    });
}

function load_comments(){
    var page = 1;
    var container = document.querySelector('#events-container');
    var $tpl = $('#comment-event-item');
    var $list = $('#comments-container');
    var template = _.template($tpl.text());
    var $buttonNextPage = $('#comments-next-page');
    var loadCommentsPage = function (page) {
        var url = $tpl.data('remote') + '&page=' + page;
        $.get(url, function (data) {
            if (data.pageCount == 0 || data.pageCount == page) {
                $buttonNextPage.hide();
            }
            $.each(data.items, function (k, v) {
                $list.append(template(v))
            })
        });
    }
    loadCommentsPage(page);
    $buttonNextPage.click(function () {
        loadCommentsPage(++page);
        return false;
    });
}

function sent(obj) {
    var obj = $(obj);
    var siblings = obj.siblings("#msg_cnt");
    var notify_all = $("#notify_all");
    //console.log(notify_all.prop("checked"));
    //return;
    if(siblings.text() == ''){
        return false;
    }
    $.ajax({
        type: "POST",
        url: "/comment/add-comment",
        dataType: "JSON",
        data: {
            message: siblings.text(),
            event_id: siblings.data('eid'),
            notify_all: notify_all.prop("checked")
        },
        success: function (msg) {
            var d = new Date();
            var day = d.getDate();
            var month = d.getMonth() + 1;
            var year = d.getFullYear();
            if(month < 10 ){ month = '0' + month;}
            var hours = d.getHours();
            var minutes = d.getMinutes();
            var seconds = d.getSeconds();

            var date =  'Сегодня: '+ hours + ':' + minutes + ':' + seconds;

            var comments_container = $('#comments-container');
            $('<div class="media"><div class="media-left media-middle">' +
            '<a href="'+ msg.user.link.home +'">' +
            '<img width="50" class="media-object img-circle" src="'+ msg.user.avatar.sm +'" alt="...">' +
            '</a></div>' +
            '<div class="media-body">' +
            '<h4 class="media-heading">' + msg.user.username +' | <small>'+ date +'</small></h4>'+
            msg.item.message +
            '</div></div>').prependTo(comments_container);
            siblings.text('');
        }
    });
}